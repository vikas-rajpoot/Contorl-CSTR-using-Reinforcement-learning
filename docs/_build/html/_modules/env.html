<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>env &mdash; Reinforcement learning agent to control the CSTR process. 1.0.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Reinforcement learning agent to control the CSTR process.
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">RL_1</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Reinforcement learning agent to control the CSTR process.</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">env</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for env</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">utils</span> 
<span class="kn">from</span> <span class="nn">gym</span> <span class="kn">import</span> <span class="n">spaces</span>
<span class="kn">import</span> <span class="nn">gym</span> 
<span class="kn">from</span> <span class="nn">random_sa</span> <span class="kn">import</span> <span class="n">sample_states</span><span class="p">,</span> <span class="n">sample_actions</span> 
<span class="kn">import</span> <span class="nn">simulator</span> 
<span class="c1"># import ploting </span>


<span class="c1"># maximum episode lenght </span>
<span class="n">episode_length</span> <span class="o">=</span> <span class="mi">500</span> 

<div class="viewcode-block" id="cstr_env"><a class="viewcode-back" href="../env.html#env.cstr_env">[docs]</a><span class="k">class</span> <span class="nc">cstr_env</span><span class="p">(</span><span class="n">gym</span><span class="o">.</span><span class="n">Env</span><span class="p">):</span>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            This functions used to initialize the global variables of the class.  </span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="c1"># Define action &amp; observation space   </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action_space</span> <span class="o">=</span> <span class="n">spaces</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span><span class="n">low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span> 
                                                    <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> 
                                                    <span class="n">high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span> <span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> 
                                                    <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> 
                                                    <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>   


        <span class="c1"># self.action_space = spaces.Box(low = -8500, high = 0)   </span>
        <span class="c1"># self.observation_space = spaces.Box(low=np.array([-1.0, -1.0 , -1.0, -1.0, -1.0, -1.0, -1.0, -1.0 , -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0], </span>
        <span class="c1">#                                                 dtype=np.float32), </span>
        <span class="c1">#                                                 high=np.array([1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0],  </span>
        <span class="c1">#                                                 dtype=np.float32),  </span>
        <span class="c1">#                                                 dtype=np.float32, shape=(16, ) )  </span>

        <span class="c1">##### self.action_space = spaces.Box(low = -8500, high = 0)   </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observation_space</span> <span class="o">=</span> <span class="n">spaces</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span> <span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span> <span class="p">],</span> 
                                                        <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> 
                                                        <span class="n">high</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>  
                                                        <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>  
                                                        <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>  

        <span class="c1"># n_episode variable give the current episode number. </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_episode</span> <span class="o">=</span> <span class="mi">0</span> 

        <span class="c1"># file1 = utils.global_dir + &quot;/data/open/setpoint_state_ref.csv&quot;      </span>
        <span class="c1"># file2 = utils.global_dir + &quot;/data/open/setpoint_action_ref.csv&quot;     </span>


        <span class="c1"># self.st_states = np.loadtxt(file1, delimiter=&#39;,&#39;)   </span>
        <span class="c1"># self.st_actions = np.loadtxt(file2, delimiter=&#39;,&#39;)   </span>

        <span class="c1"># self.setpoint_len = self.st_states.shape[0] </span>



<div class="viewcode-block" id="cstr_env.setpoint"><a class="viewcode-back" href="../env.html#env.cstr_env.setpoint">[docs]</a>    <span class="k">def</span> <span class="nf">setpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            function setpoint is used to give the reference state / goal state to the current episode. </span>
<span class="sd">            (this is one of the steady state of the process )</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="c1"># state = sample_states() </span>
        <span class="c1"># action = sample_actions()  </span>


        <span class="c1"># time_step = 0</span>
        <span class="c1"># x0 = None </span>
        <span class="c1"># for i in range(500): </span>
        <span class="c1">#     x0 = simulator.cstr_dynamics(time_step, time_step + 0.005, state[0],</span>
        <span class="c1">#                                 state[1], state[2], state[3], </span>
        <span class="c1">#                                 action[0], action[1])   </span>
        <span class="c1">#     state = x0  </span>
            
        
        <span class="c1"># state = x0 </span>


        <span class="bp">self</span><span class="o">.</span><span class="n">setpoint_states</span>  <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">.70</span><span class="p">,</span> <span class="mf">.60</span><span class="p">,</span> <span class="mf">127.25</span><span class="p">,</span> <span class="mf">124.39</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>     
        <span class="bp">self</span><span class="o">.</span><span class="n">setpoint_actions</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">6.01706488</span><span class="p">,</span> <span class="o">-</span><span class="mf">2655.80418483</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span> <span class="p">)</span>   
 
        <span class="c1"># index = self.n_episode % self.setpoint_len </span>

        <span class="c1"># print(&quot;setpoint length : &quot;, self.setpoint_len )  </span>
        <span class="c1"># index = np.random.randint(0, self.setpoint_len)  </span>

        <span class="c1"># print(&quot;index : &quot;, index) </span>

        <span class="c1"># self.setpoint_states = self.st_states[index, :] </span>
        <span class="c1"># self.setpoint_actions = self.st_actions[index, :] </span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scaled_setpoint_state</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">normalize_minmax_states</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setpoint_states</span><span class="p">)</span>     <span class="c1"># type: ignore</span>


        <span class="k">return</span> <span class="kc">None</span> </div>
    

<div class="viewcode-block" id="cstr_env.save_episode_data"><a class="viewcode-back" href="../env.html#env.cstr_env.save_episode_data">[docs]</a>    <span class="k">def</span> <span class="nf">save_episode_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># dir = utils.global_dir + &quot;/data/training_data&quot;   </span>

        <span class="c1"># np.savetxt(dir + &quot;/&quot;+str(self.n_episode)+&quot;ep_states.csv&quot; , self.ep_states, delimiter=&#39;,&#39;)  </span>
        <span class="c1"># np.savetxt(dir + &quot;/&quot;+str(self.n_episode)+&quot;ep_actions.csv&quot; , self.ep_actions, delimiter=&#39;,&#39;)  </span>

        <span class="c1"># # np.savetxt(dir + &quot;/&quot;+str(self.n_episode)+&quot;se_ep_states.csv&quot; , self.se_ep_states, delimiter=&#39;,&#39;)  </span>
        <span class="c1"># # np.savetxt(dir + &quot;/&quot;+str(self.n_episode)+&quot;se_ep_actions.csv&quot; , self.se_ep_actions, delimiter=&#39;,&#39;)  </span>

        <span class="c1"># # np.savetxt(dir + &quot;/&quot;+str(self.n_episode)+&quot;s_states.csv&quot; , self.s_ep_states, delimiter=&#39;,&#39;)  </span>
        <span class="c1"># # np.savetxt(dir + &quot;/&quot;+str(self.n_episode)+&quot;s_actions.csv&quot; , self.s_ep_actions, delimiter=&#39;,&#39;)  </span>

        <span class="c1"># dir1 = utils.global_dir + &quot;/data/training_plots&quot;  </span>

        <span class="c1"># file1 = dir1 + &quot;/&quot;+str(self.n_episode)+&quot;_xu_.png&quot;  </span>
        <span class="c1"># # file2 = dir1 + &quot;/&quot;+str(self.n_episode)+&quot;se_fig_.png&quot;  </span>
        <span class="c1"># # file3 = dir1 + &quot;/&quot;+str(self.n_episode)+&quot;s_fig_.png&quot;  </span>
        
        <span class="c1"># ploting.plot_rl_comparision(self.ep_states, self.ep_actions, self.setpoint_states, 0, file1)  </span>
        <span class="c1"># # ploting.plot_rl_comparision(self.se_ep_states, self.se_ep_actions, 0, file2)  </span>
        <span class="c1"># # ploting.plot_rl_comparision(self.s_ep_states, self.s_ep_actions, 0, file3)  </span>

        <span class="c1"># file4 = dir1 + &quot;/&quot;+str(self.n_episode)+&quot;_e.png&quot;  </span>
        <span class="c1"># ploting.plot_x(self.errors_, 0, file4) </span>
        
        <span class="c1"># file5 = dir1 + &quot;/&quot;+str(self.n_episode)+&quot;_i_e.png&quot;  </span>
        <span class="c1"># ploting.plot_x(self.integral_errors_, 0, file5)    </span>

        <span class="k">pass</span> </div>


<div class="viewcode-block" id="cstr_env.initial_sa"><a class="viewcode-back" href="../env.html#env.cstr_env.initial_sa">[docs]</a>    <span class="k">def</span> <span class="nf">initial_sa</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            function setpoint is used to give the initial state for the current episode (this is one of the steady state of the process ). </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">sample_states</span><span class="p">()</span> 
        <span class="n">action</span> <span class="o">=</span> <span class="n">sample_actions</span><span class="p">()</span>  


        <span class="n">time_step</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">state</span> 
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">500</span><span class="p">):</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">simulator</span><span class="o">.</span><span class="n">cstr_dynamics</span><span class="p">(</span><span class="n">time_step</span><span class="p">,</span> <span class="n">time_step</span> <span class="o">+</span> <span class="mf">0.005</span><span class="p">,</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                        <span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> 
                                        <span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">action</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>   
            <span class="n">state</span> <span class="o">=</span> <span class="n">x0</span>  
            
        
        <span class="n">state</span> <span class="o">=</span> <span class="n">x0</span> 

        <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">action</span></div>

 
<div class="viewcode-block" id="cstr_env.calculate_reward"><a class="viewcode-back" href="../env.html#env.cstr_env.calculate_reward">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_reward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_next</span><span class="p">,</span> <span class="n">u_curr</span><span class="p">,</span> <span class="n">u_prev</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            calculate reward funtion is used to calculate the reward value for state :math:`S_t`  at time instant t. </span>
<span class="sd">            Arguments : </span>
<span class="sd">                x_next(array) : next state when take the action :math:`A_t` at the state :math:`S_t`. </span>
<span class="sd">                u_curr (array) : action at the current time instant t. </span>
<span class="sd">                u_prev (array) : action at the previous time instatn t-1. </span>
<span class="sd">        &quot;&quot;&quot;</span> 

        <span class="n">s_x_next</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">normalize_minmax_states</span><span class="p">(</span><span class="n">x_next</span><span class="p">)</span> 

        <span class="c1"># s_u_curr = utils.normalize_minmax_actions(u_curr) </span>
        <span class="c1"># s_u_prev = utils.normalize_minmax_actions(u_prev) </span>

        <span class="c1"># r = np.sum( (s_x_next - self.scaled_setpoint_state)** 2)     </span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="p">(</span><span class="n">s_x_next</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaled_setpoint_state</span><span class="p">)</span><span class="o">**</span> <span class="mi">2</span><span class="p">)</span>  

        <span class="c1"># r = np.sum((x_next - se_setpoint)** 2) + np.sum( (u_curr - u_prev) ** 2)  </span>

        <span class="c1"># r = (x_next[1] - self.setpoint_states[1]) ** 2 # type: ignore</span>

        <span class="n">reward</span> <span class="o">=</span> <span class="o">-</span><span class="n">r</span> 
        
        <span class="k">return</span> <span class="n">reward</span> </div>


<div class="viewcode-block" id="cstr_env.calculate_errors"><a class="viewcode-back" href="../env.html#env.cstr_env.calculate_errors">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Calculate the error between the current &#39;state&#39; vector :math:`[C_A, C_B, T_R, T_K]` and reference state :math:`[C_{A, ref}, C_{B, ref}, T_{R, ref}, T_{K, ref}]`. </span>

<span class="sd">            Arguments : </span>
<span class="sd">                state (array): current state of the precess. </span>
<span class="sd">            </span>
<span class="sd">            Return : </span>
<span class="sd">                errors (array): errors of the of current state</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># errors = (state - self.setpoint_states)** 2   </span>
        <span class="n">errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">state</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">setpoint_states</span><span class="p">)</span>  

        <span class="bp">self</span><span class="o">.</span><span class="n">errors_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errors_</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> 

        <span class="k">return</span> <span class="n">errors</span> </div>


<div class="viewcode-block" id="cstr_env.calculate_integral_errors"><a class="viewcode-back" href="../env.html#env.cstr_env.calculate_integral_errors">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_integral_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Calculate the integral error between of current &#39;state&#39; vector :math:`[C_A, C_B, T_R, T_K]` </span>
<span class="sd">            Arguments : </span>
<span class="sd">            </span>
<span class="sd">            Return : </span>
<span class="sd">                integral errors (array) : </span>
<span class="sd">        &quot;&quot;&quot;</span>      

        <span class="n">integral_errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errors_</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> 

        <span class="bp">self</span><span class="o">.</span><span class="n">integral_errors_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">integral_errors_</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">integral_errors</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  

        <span class="k">return</span> <span class="n">integral_errors</span> </div>


<div class="viewcode-block" id="cstr_env.is_done"><a class="viewcode-back" href="../env.html#env.cstr_env.is_done">[docs]</a>    <span class="k">def</span> <span class="nf">is_done</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_next</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Check the done condition i.e. weather the last five consecutive states are within the defined epsilon or not. </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">done</span><span class="o">=</span><span class="kc">False</span>

        <span class="n">c1</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x_next</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">setpoint_states</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">)</span>   <span class="c1"># type: ignore</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x_next</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">setpoint_states</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">)</span>   <span class="c1"># type: ignore</span>
        <span class="n">c3</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x_next</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">setpoint_states</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">)</span>    <span class="c1"># type: ignore</span>
        <span class="n">c4</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x_next</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">setpoint_states</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">)</span>    <span class="c1"># type: ignore</span>


        <span class="n">steady_state</span> <span class="o">=</span> <span class="n">c1</span> <span class="ow">and</span> <span class="n">c2</span> <span class="ow">and</span> <span class="n">c3</span> <span class="ow">and</span> <span class="n">c4</span> 

        <span class="bp">self</span><span class="o">.</span><span class="n">goal_state_done</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ep_step</span><span class="p">]</span> <span class="o">=</span> <span class="n">steady_state</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ep_step</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span> 
            <span class="n">p5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal_state_done</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ep_step</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> 
            <span class="n">p4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal_state_done</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ep_step</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> 
            <span class="n">p3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal_state_done</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ep_step</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> 
            <span class="n">p2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal_state_done</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ep_step</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 
            <span class="n">p1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal_state_done</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ep_step</span><span class="o">-</span><span class="mi">0</span><span class="p">]</span> 

            <span class="k">if</span> <span class="n">p5</span> <span class="ow">and</span> <span class="n">p4</span> <span class="ow">and</span> <span class="n">p3</span> <span class="ow">and</span> <span class="n">p2</span> <span class="ow">and</span> <span class="n">p1</span><span class="p">:</span>
                <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>  


        <span class="k">return</span> <span class="n">done</span> </div>


<div class="viewcode-block" id="cstr_env.step"><a class="viewcode-back" href="../env.html#env.cstr_env.step">[docs]</a>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s_action</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Step function take the action of the agent and returns the next-observation to the agent. </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">action</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">reverse_normalize_minmax_actions</span><span class="p">(</span><span class="n">s_action</span><span class="p">)</span> 

        <span class="bp">self</span><span class="o">.</span><span class="n">current_u</span> <span class="o">=</span> <span class="n">action</span> 

        <span class="c1"># print(&quot;action : &quot;, action) </span>
        
        <span class="k">try</span> <span class="p">:</span>
            <span class="n">time_step</span> <span class="o">=</span> <span class="mi">0</span>   
            <span class="n">x_next</span> <span class="o">=</span> <span class="n">simulator</span><span class="o">.</span><span class="n">cstr_dynamics</span><span class="p">(</span><span class="n">time_step</span><span class="p">,</span> <span class="n">time_step</span> <span class="o">+</span> <span class="mf">0.005</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_s</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="c1"># type: ignore</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">current_s</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_s</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_s</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>  <span class="c1"># type: ignore</span>
                                            <span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">action</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># type: ignore</span>
            
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Overflow error occured : &quot;</span><span class="p">)</span>  
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;actions : &quot;</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span> 
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;states : &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_s</span> <span class="p">)</span> 
            <span class="n">x_next</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_s</span>   

        
        <span class="c1"># print(&quot;X_next : &quot;, x_next) </span>

        <span class="n">done</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_done</span><span class="p">(</span><span class="n">x_next</span><span class="p">)</span>   

        <span class="c1"># print(&quot;done : &quot;, done)    </span>

        <span class="n">reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_reward</span><span class="p">(</span><span class="n">x_next</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">previous_u</span><span class="p">)</span> 

        <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_errors</span><span class="p">(</span><span class="n">x_next</span><span class="p">)</span>   

        <span class="n">integral_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_integral_errors</span><span class="p">()</span> 

        <span class="n">s_error</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">normalize_minmax_error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>  
        <span class="n">s_integral_error</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">normalize_minmax_ierror</span><span class="p">(</span><span class="n">integral_error</span><span class="p">)</span>   


        <span class="n">s_x_next</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">normalize_minmax_states</span><span class="p">(</span><span class="n">x_next</span><span class="p">)</span>   <span class="c1"># type: ignore</span>
        <span class="c1"># s_action = utils.normalize_minmax_actions(se_action) </span>

        <span class="c1"># observations = np.concatenate([s_x_next, self.scaled_setpoint_state,  s_error, s_integral_error]) </span>
        <span class="n">observations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">s_x_next</span><span class="p">,</span>  <span class="n">s_error</span><span class="p">])</span> 


        <span class="bp">self</span><span class="o">.</span><span class="n">ep_states</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ep_states</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">x_next</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>   <span class="c1"># type: ignore   </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ep_actions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ep_actions</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>       

        <span class="bp">self</span><span class="o">.</span><span class="n">previous_u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_u</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">current_s</span> <span class="o">=</span> <span class="n">x_next</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ep_step</span> <span class="o">+=</span> <span class="mi">1</span>  


        <span class="c1"># print(observations) </span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ep_step</span> <span class="o">==</span> <span class="n">episode_length</span> <span class="ow">or</span> <span class="n">done</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_episode</span><span class="o">%</span><span class="n">episode_length</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">episode_length</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">episode_length</span><span class="o">-</span><span class="mi">1</span> <span class="p">]:</span>     
            <span class="c1"># print(self.n_episode)  </span>
            <span class="c1"># print(self.n_episode%20)   </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_episode_data</span><span class="p">()</span> 


        <span class="n">trancated</span> <span class="o">=</span> <span class="kc">False</span> 
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ep_step</span> <span class="o">==</span> <span class="n">episode_length</span><span class="p">:</span>
            <span class="n">trancated</span> <span class="o">=</span> <span class="kc">True</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ep_step</span> <span class="o">==</span> <span class="n">episode_length</span><span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">done</span><span class="p">:</span>      
            <span class="bp">self</span><span class="o">.</span><span class="n">n_episode</span> <span class="o">+=</span> <span class="mi">1</span> 
        
        <span class="n">terminated</span> <span class="o">=</span> <span class="n">done</span>


        <span class="k">return</span> <span class="n">observations</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">terminated</span><span class="p">,</span> <span class="n">trancated</span><span class="p">,</span> <span class="p">{}</span>    </div>


<div class="viewcode-block" id="cstr_env.reset"><a class="viewcode-back" href="../env.html#env.cstr_env.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Reset functions is called at start of each episode. It is used to give the initial state to agent and set the goal state. </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ep_step</span> <span class="o">=</span> <span class="mi">0</span> 

        <span class="bp">self</span><span class="o">.</span><span class="n">current_u</span><span class="o">=</span> <span class="kc">None</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_u</span> <span class="o">=</span> <span class="kc">None</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">current_s</span> <span class="o">=</span> <span class="kc">None</span> 

        <span class="bp">self</span><span class="o">.</span><span class="n">goal_state_done</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span>  <span class="p">(</span><span class="n">episode_length</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">errors_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>   
        <span class="bp">self</span><span class="o">.</span><span class="n">integral_errors_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>    

        <span class="bp">self</span><span class="o">.</span><span class="n">setpoint_states</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setpoint_actions</span> <span class="o">=</span> <span class="kc">None</span> 

        <span class="bp">self</span><span class="o">.</span><span class="n">ep_states</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ep_actions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> 

        <span class="bp">self</span><span class="o">.</span><span class="n">setpoint</span><span class="p">()</span>  


        <span class="c1"># state, action = self.initial_sa()    </span>
        <span class="n">state</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.04</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">140.52</span><span class="p">,</span> <span class="mf">139.10</span> <span class="p">]),</span>  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">21.01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1234.44</span><span class="p">])</span> 

        <span class="c1"># self.ep_states  = np.append(self.ep_states, np.copy(state.reshape(1, 4)), axis=0)      </span>
        <span class="c1"># self.ep_actions = np.append(self.ep_actions, np.copy(action.reshape(1, 2)), axis=0)        </span>


        <span class="bp">self</span><span class="o">.</span><span class="n">current_u</span> <span class="o">=</span> <span class="n">action</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_u</span> <span class="o">=</span> <span class="n">action</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">current_s</span> <span class="o">=</span> <span class="n">state</span> 

        <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_errors</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>  

        <span class="n">error_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">error</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">error</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">error</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>   

        <span class="n">utils</span><span class="o">.</span><span class="n">act_range_max_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">error_max</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>     


        <span class="n">integral_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_integral_errors</span><span class="p">()</span>  
        <span class="n">utils</span><span class="o">.</span><span class="n">act_range_max_ie</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">error_max</span><span class="p">)</span><span class="o">*</span><span class="mi">300</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>  

        <span class="n">s_error</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">normalize_minmax_states</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> 
        <span class="n">s_integral_error</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">normalize_minmax_ierror</span><span class="p">(</span><span class="n">integral_error</span><span class="p">)</span>  

        <span class="n">s_state</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">normalize_minmax_states</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>   
        <span class="c1"># s_action = utils.normalize_minmax_actions(action) </span>


        <span class="c1"># print(&quot;e&quot;)   </span>

        <span class="c1"># observations = np.concatenate([s_state, self.scaled_setpoint_state, s_error, s_integral_error]) </span>
        <span class="n">observations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">s_state</span><span class="p">,</span> <span class="n">s_error</span><span class="p">])</span> 

        <span class="c1"># print(observations)  </span>
        <span class="c1"># print(&quot;end&quot;)   </span>


        <span class="n">info_dic</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;setpoint_state&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">setpoint_states</span><span class="p">,</span> 
            <span class="s2">&quot;setpoint_action&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">setpoint_actions</span><span class="p">,</span>
            <span class="s2">&quot;error_max&quot;</span><span class="p">:</span> <span class="n">error_max</span>
        <span class="p">}</span> 

        <span class="k">return</span> <span class="n">observations</span><span class="p">,</span> <span class="n">info_dic</span> </div></div>


</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Vikas Rajpoot.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>